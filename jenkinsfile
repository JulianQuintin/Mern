pipeline {
    agent any

    environment {
        DOCKER_CMD = '/usr/local/bin/docker'
        KUBECTL_CMD = '/usr/local/bin/kubectl'
        DOCKER_IMAGE = "julianquintin/mern-mysql-crud-master:${env.BUILD_NUMBER}"
        MINIKUBE_PROFILE = "mern-cluster"
    }

    stages {
        stage('Verify Dependencies') {
            steps {
                script {
                    // Verificar todas las dependencias primero
                    def missingTools = []
                    
                    if (!sh(script: 'command -v minikube', returnStatus: true)) {
                        missingTools << 'Minikube'
                    }
                    if (!sh(script: 'command -v docker', returnStatus: true)) {
                        missingTools << 'Docker'
                    }
                    if (!sh(script: 'command -v kubectl', returnStatus: true)) {
                        missingTools << 'kubectl'
                    }
                    
                    if (missingTools) {
                        error("ERROR: Herramientas faltantes: ${missingTools.join(', ')}. Instala antes de continuar.")
                    }
                }
            }
        }

        stage('Start Minikube Cluster') {
            steps {
                script {
                    sh """
                        # Iniciar Minikube si no está corriendo
                        if ! minikube status -p ${MINIKUBE_PROFILE} &> /dev/null; then
                            minikube start -p ${MINIKUBE_PROFILE} --driver=docker \
                                --cpus=4 --memory=8192 --disk-size=20g
                        fi

                        # Configurar entorno
                        eval \$(minikube docker-env -p ${MINIKUBE_PROFILE})
                        export KUBECONFIG=\$(minikube kubectl config view -p ${MINIKUBE_PROFILE} --flatten)
                    """
                }
            }
        }

        // Resto de tus stages (Checkout, Build, Deploy)...
        // Mantén el resto de tu pipeline igual que antes
    }
}